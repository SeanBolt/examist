
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Test Design Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="continuous-integration.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Research
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../research/downloading-papers.html">
            
                <a href="../research/downloading-papers.html">
            
                    
                    Downloading Exam Papers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../research/parsing-papers.html">
            
                <a href="../research/parsing-papers.html">
            
                    
                    Parsing Exam Papers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Design
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../design/architecture.html">
            
                <a href="../design/architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../design/database.html">
            
                <a href="../design/database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../design/api.html">
            
                <a href="../design/api.html">
            
                    
                    API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../design/ui.html">
            
                <a href="../design/ui.html">
            
                    
                    UI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Implementation
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../implementation/project-structure.html">
            
                <a href="../implementation/project-structure.html">
            
                    
                    Project Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../implementation/backend.html">
            
                <a href="../implementation/backend.html">
            
                    
                    Backend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../implementation/frontend.html">
            
                <a href="../implementation/frontend.html">
            
                    
                    Frontend
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Development
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../development/version-control.html">
            
                <a href="../development/version-control.html">
            
                    
                    Version Control
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../development/tools.html">
            
                <a href="../development/tools.html">
            
                    
                    Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../development/workflow.html">
            
                <a href="../development/workflow.html">
            
                    
                    Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../development/migrations.html">
            
                <a href="../development/migrations.html">
            
                    
                    Migrations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../development/deploying.html">
            
                <a href="../development/deploying.html">
            
                    
                    Deploying
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Testing
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.6.1" data-path="test-design.html">
            
                <a href="test-design.html">
            
                    
                    Test Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="continuous-integration.html">
            
                <a href="continuous-integration.html">
            
                    
                    Continuous Integration
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../results.html">
            
                <a href="../results.html">
            
                    
                    Results
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../conclusions.html">
            
                <a href="../conclusions.html">
            
                    
                    Conclusions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../references.html">
            
                <a href="../references.html">
            
                    
                    References
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" >
            
                <span>
            
                    
                    Appendices
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../appendices/test-fixtures.html">
            
                <a href="../appendices/test-fixtures.html">
            
                    
                    Appendix 1: Test Fixtures
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../appendices/paper-specification.html">
            
                <a href="../appendices/paper-specification.html">
            
                    
                    Appendix 2: Exam Paper Specification
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Test Design</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="5-testing">5. Testing</h1><h2 id="51-test-design">5.1 Test Design</h2><p>Precautions were taken to ensure the tests for the project were reliable and consistent. Ensuring that <em>good</em> tests were easy to write was also a huge part of the philosophy behind testing in the project.</p><h3 id="backend">Backend</h3><p>The API has a large suite of tests to ensure any changes to models or blueprints don&apos;t break anything. Whenever a change is made to any part of the codebase, the entire suite of tests must be run to check each endpoint is returning the data is supposed to. For each endpoint within the app, there is an average of 3 tests that ensure to test three things:</p><ol><li><p><strong>A request with invalid parameters fails.</strong></p><p>These are usually POST or PUT requests that send data to the server. The body of these requests must follow a strict schema and each field must have the correct data type. This includes parameters within the endpoint&apos;s URL itself. These tests are designed for security purposes to prevent SQL injection and meddling with parameters that are not publicly accessible.</p></li>
<li><p><strong>A request with invalid data fails.</strong></p><p>Again, these are usually POST or PUT requests that send data to the server intending to be processed in some way. The endpoint has to be tested to ensure the integrity of the existing data is not compromised by incoming valid data. Examples are when trying to create new users when an email already exists for that user or trying to update an entity that violates a constraint within the database.</p></li>
<li><p><strong>The response returned the correct data.</strong></p><p>Probably the most important test of the three is that given a valid request, the API returns the expected data. This is to ensure that interfaces built for the API can trust the server to always return data in the same format and structure.</p></li></ol>
<h4 id="fixtures">Fixtures</h4><p>The key to testing an application is making it easy to write good tests. Tests should be simple, complete and deterministic. When writing a test takes longer than writing the implementation of the code being tested, something is wrong. To avoid that trap and make writing tests as easy as possible for the API, the test suite made heavy use of Py.Test fixtures.</p><p>Fixtures are methods, that when called, perform some setup for the test suite. This includes connecting the database, creating the tables, importing sample data and generally laying down the foundations for tests so that they can act upon real data.</p><p>The fixtures are designed to have zero side effects. This means that any database commits or file changes <em>always</em> rollback their changes to the initial state. Now, every time a fixture is required, the test can expect a clean slate. Fixtures can be scoped to the &quot;session&quot; or &quot;function&quot;. The session scope turns the fixture into a singleton that when required first is executed and all following uses have the same value. This is useful for setting up the database connection and creating the tables which needs to be done only once per testing session. The function scope forces the fixture to be executed every time a test unit requires the fixture, this is useful for using SQL Alchemy&apos;s Session object and rollback any changes made to the database during that test.</p><h4 id="sample-test">Sample Test</h4><pre><code class="lang-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_profile_delete_course</span><span class="hljs-params">(auth_client, user_with_courses, session)</span>:</span>
    existingCourse = user_with_courses.courses[<span class="hljs-number">0</span>]
    resp = auth_client.delete(<span class="hljs-string">&quot;/profile/courses&quot;</span>, 
        data={ <span class="hljs-string">&quot;course&quot;</span>: existingCourse.id })

    assert_api_success(resp)

    session.refresh(user_with_courses)
    <span class="hljs-keyword">assert</span> len(user_with_courses.courses) == <span class="hljs-number">4</span>
    <span class="hljs-keyword">assert</span> <span class="hljs-keyword">not</span> find(user_with_courses.courses, 
        <span class="hljs-keyword">lambda</span> mod: mod.id == existingCourse.id)</code></pre>
<p>Above we have an example test <code>test_profile_delete_course</code> which sends a request to the API attempting to remove a course from a user&apos;s associated courses. From the method arguments, we can see it uses three fixtures (Py.Test automatically resolves the arguments to fixtures when it runs the test): <code>auth_client</code>, <code>user_with_courses</code> and <code>session</code> (for a full list of fixtures, see Appendix 1: Test Fixtures).</p><p>The <code>auth_client</code> provides an API client that has a logged in session and user associated with it and any requests made are authorised. This saves the hassle of having to write login code for every test (if I wanted an unauthorised client, I&apos;d ask for the <code>client</code> fixture). The <code>user_with_courses</code> fixture returns a user with courses associated at &quot;function&quot; scope and committed to the database. Finally, the session object is an SQL Alchemy Session object we can use to query the database to ensure any changes made by the API exist in the database.</p><p>The first two lines of the test used the auth client to make a <em>DELETE</em> request to <code>/profiles/courses</code> with the ID of a course that a user has associated. We want to remove that course from the user&apos;s associated courses.</p><p>Next, we <code>assert_api_success</code> which checks that the API returned a <code>200 OK</code> and the standard success response. If it doesn&apos;t, it will raise an <code>AssertionError</code> and the test will fail. Finally, we make sure the change has persisted to the database by refreshing the <code>User</code> entity and ensuring the course is not associated anymore.</p><p>When the test is complete, <em>everything</em> is rolled back to the state before the test started including the user&apos;s login session created for the <code>auth_client</code> and the new user and their courses created in the <code>user_with_courses</code>. If any following tests require those fixtures, everything has to be recommitted to the database from scratch again. This may seem cumbersome and slow however it is the best way to ensure that every test will not be negatively affected by unintended side effects.</p><h4 id="assertions">Assertions</h4><p>The application implements a suite of custom assertions specifically tailored to the API. In line with the principle of making good tests easy to write, there are three methods:</p><ol><li><p><code>assert_api_error( response, status_code [, message, meta ] )</code></p><p>This method takes an API response from the client and asserts that a HTTP error response was returned that matches <code>status_code</code>. The method also allows for testing the contents of the error message and the schema of the meta object.</p></li>
<li><p><code>assert_api_success( resp )</code></p><p>This method takes asserts the API has returned a <code>200 OK</code> and matches the standard success API response.</p></li>
<li><p><code>assert_api_response( resp )</code></p><p>The <code>assert_api_response</code> method asserts we have a <code>200 OK</code> returned from the API. It also serves another purpose of parsing the JSON response and yielding the object:</p><pre><code class="lang-py"> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_resp</span><span class="hljs-params">(client)</span>:</span>
     resp = client.get(<span class="hljs-string">&quot;/courses&quot;</span>)

     <span class="hljs-keyword">with</span> assert_api_response(resp) <span class="hljs-keyword">as</span> data:
         <span class="hljs-keyword">assert</span> <span class="hljs-string">&quot;courses&quot;</span> <span class="hljs-keyword">in</span> data
         <span class="hljs-keyword">assert</span> len(data[<span class="hljs-string">&quot;courses&quot;</span>] &gt; <span class="hljs-number">5</span>)</code></pre>
</li></ol>
<h4 id="logging">Logging</h4><p>Since the development workflow of the backend is mostly TDD (Test Driven Development), it&apos;s important that the output and logs of the code being tested is easily accessible to ensure the code is performing as it should. For the test suite, a lot of effort was put into ensuring the log output was as readable and approachable as possible. There was a couple of steps involved in reach the current state.</p><p><img alt="Output of a test run. Notice the highlighted SQL." src="assets/test-output.png"></p><p>First off, Py.test does a poor job of reporting test execution. By default it suppresses any output unless the command line flag <code>-s</code> is enabled. Even with that, only a period is outputted after the test has completed execution. The first change to the output was to mark the beginning and end of a test run using large, guarded markers with the test name.</p><p>The next modification to the logging output was making SQL Alchemy&apos;s SQL output readable. This was no easy task because SQL Alchemy spits out <em>huge</em> chunks, line by line which leads to unparseable walls of text. SQL Alchemy uses Python&apos;s native <code>logging</code> module which allows you to plug in your own formatters and filters. The SQL Alchemy logger was modified to colorise, indent and pad the queries with any parameters displayed just below.</p><p><img alt="Unformatted SQL output vs Formatted" src="assets/SQL-formatted.png"></p><p>Finally, the last modification was only logging data that was relevant to the test. The fixtures produce <em>a lot</em> of output such as SQL queries and any other function call and created <em>large</em> chunks of text before the test even started running. Py.Test unfortunately did not have the facility to turn off output from fixtures so a custom solution has to be built. From deep within the Py.Test docs, I found two &quot;hooks&quot; which would call a method before and after each test run called (<code>pytest_runtest_call</code>, <code>pytest_runtest_teardown</code>). From there, it was simply a matter of turning on and off the output from any loggers and isolate only the test output.</p>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="continuous-integration.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Continuous Integration">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Test Design","level":"1.6.1","depth":2,"next":{"title":"Continuous Integration","level":"1.6.2","depth":2,"path":"testing/continuous-integration.md","ref":"testing/continuous-integration.md","articles":[]},"previous":{"title":"Testing","level":"1.6","depth":1,"ref":"","articles":[{"title":"Test Design","level":"1.6.1","depth":2,"path":"testing/test-design.md","ref":"testing/test-design.md","articles":[]},{"title":"Continuous Integration","level":"1.6.2","depth":2,"path":"testing/continuous-integration.md","ref":"testing/continuous-integration.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"testing/test-design.md","mtime":"2016-04-21T18:11:41.000Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2016-09-26T14:54:48.984Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

